icon: https://raw.githubusercontent.com/friends-of-forkcms/fork-cms-module-commerce/master/deploy/icon.png
deploy:
  # Build docker image
  - |
    if [[ "$OKTETO_GIT_BRANCH" == "master" ]]; then
      export IMAGE_TAG="latest"
      okteto build --build-arg THEME_NAME=CommerceDemo -t okteto.dev/fork-cms-module-commerce-demo:${IMAGE_TAG}
    else
      export IMAGE_TAG="${OKTETO_GIT_COMMIT}"
      echo "Tag: $IMAGE_TAG"
      okteto build --build-arg THEME_NAME=CommerceDemo --cache-from okteto.dev/fork-cms-module-commerce-demo:latest -t okteto.dev/fork-cms-module-commerce-demo:${IMAGE_TAG}
    fi

  - printenv
  - echo "Finished building docker image with tag ${IMAGE_TAG} for branch ${OKTETO_GIT_BRANCH}"

  # Inject the container image tag
  - cd k8s && kustomize edit set image okteto.dev/fork-cms-module-commerce-demo=okteto.dev/fork-cms-module-commerce-demo:${IMAGE_TAG}

#  # Inject the app label
#  - echo $OKTETO_NAMESPACE
#  - printenv
#  - cd k8s && kustomize edit set label app:$OKTETO_NAMESPACE

  # Inject the name suffix, e.g. fork-cms-module-commerce-demo-pr-1
  #  - if [[ $OKTETO_NAMESPACE == *"-pr-"* ]]; then NAMESUFFIX=$(echo $OKTETO_NAMESPACE | sed "s/.*-pr-//" | awk '{print "-pr-"$1}') && cd k8s && kustomize edit set namesuffix -- "$NAMESUFFIX"; fi
  #  - echo $NAMESUFFIX

  # Deploy Kubernetes manifest using Kustomize.
  # Use envsubst to replace env values, e.g. for injecting the SITE_DOMAIN.
  - kustomize build ./k8s | envsubst # For debugging
  - kustomize build ./k8s | envsubst | kubectl apply -f -
